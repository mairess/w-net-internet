<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlanIntegrationTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in w-net-internet Coverage Results</a> &gt; <a href="index.source.html" class="el_package">com.maires.wnet.integration</a> &gt; <span class="el_source">PlanIntegrationTest.java</span></div><h1>PlanIntegrationTest.java</h1><pre class="source lang-java linenums">package com.maires.wnet.integration;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.put;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

import com.maires.wnet.entity.Address;
import com.maires.wnet.entity.Customer;
import com.maires.wnet.entity.Equipment;
import com.maires.wnet.entity.EquipmentType;
import com.maires.wnet.entity.Installation;
import com.maires.wnet.entity.Plan;
import com.maires.wnet.entity.Technician;
import com.maires.wnet.entity.User;
import com.maires.wnet.repository.AddressRepository;
import com.maires.wnet.repository.CustomerRepository;
import com.maires.wnet.repository.EquipmentRepository;
import com.maires.wnet.repository.InstallationRepository;
import com.maires.wnet.repository.PlanRepository;
import com.maires.wnet.repository.TechnicianRepository;
import com.maires.wnet.repository.UserRepository;
import com.maires.wnet.security.Role;
import com.maires.wnet.service.TokenService;
import java.util.ArrayList;
import java.util.List;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.test.context.DynamicPropertyRegistry;
import org.springframework.test.context.DynamicPropertySource;
import org.springframework.test.web.servlet.MockMvc;
import org.testcontainers.containers.KafkaContainer;
import org.testcontainers.containers.PostgreSQLContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;
import org.testcontainers.shaded.com.fasterxml.jackson.databind.ObjectMapper;

@SpringBootTest
@AutoConfigureMockMvc
@Testcontainers
@DisplayName(&quot;Plan integration tests&quot;)
<span class="fc" id="L50">public class PlanIntegrationTest {</span>

  @Container
<span class="fc" id="L53">  public static PostgreSQLContainer POSTGRES_CONTAINER = new PostgreSQLContainer(&quot;postgres&quot;)</span>
<span class="fc" id="L54">      .withDatabaseName(&quot;wnetdb&quot;);</span>
  @Container
<span class="fc" id="L56">  public static KafkaContainer KAFKA_CONTAINER = new KafkaContainer();</span>
  @Autowired
  PlanRepository planRepository;
  @Autowired
  UserRepository userRepository;
  @Autowired
  AddressRepository addressRepository;
  @Autowired
  TechnicianRepository technicianRepository;
  @Autowired
  EquipmentRepository equipmentRepository;
  @Autowired
  CustomerRepository customerRepository;
  @Autowired
  InstallationRepository installationRepository;
  @Autowired
  MockMvc mockMvc;
  @Autowired
  private TokenService tokenService;
  private String tokenAdmin;

  @DynamicPropertySource
  public static void overrideProperties(DynamicPropertyRegistry registry) {
<span class="fc" id="L79">    registry.add(&quot;spring.datasource.url&quot;, POSTGRES_CONTAINER::getJdbcUrl);</span>
<span class="fc" id="L80">    registry.add(&quot;spring.datasource.username&quot;, POSTGRES_CONTAINER::getUsername);</span>
<span class="fc" id="L81">    registry.add(&quot;spring.datasource.password&quot;, POSTGRES_CONTAINER::getPassword);</span>
<span class="fc" id="L82">    registry.add(&quot;spring.kafka.bootstrap-servers&quot;, KAFKA_CONTAINER::getBootstrapServers);</span>
<span class="fc" id="L83">  }</span>

  @BeforeEach
  public void cleanUp() {
<span class="fc" id="L87">    userRepository.deleteAll();</span>
<span class="fc" id="L88">    planRepository.deleteAll();</span>
<span class="fc" id="L89">    User admin = new User(null, &quot;System Manager Administrator&quot;, &quot;admin@mail.com&quot;, &quot;admin&quot;,</span>
        &quot;segredo123&quot;,
        Role.ADMIN);
<span class="fc" id="L92">    User userAdmin = userRepository.save(admin);</span>
<span class="fc" id="L93">    tokenAdmin = tokenService.generateToken(userAdmin.getUsername());</span>
<span class="fc" id="L94">  }</span>

  @Test
  @DisplayName(&quot;Retrieval all plans&quot;)
  public void testPlanRetrievalAll() throws Exception {
<span class="fc" id="L99">    Plan planOne = new Plan(&quot;Speed of Light&quot;, 299, 100.0);</span>
<span class="fc" id="L100">    Plan planTwe = new Plan(&quot;Low Connection&quot;, 10, 50.0);</span>

<span class="fc" id="L102">    planRepository.save(planOne);</span>
<span class="fc" id="L103">    planRepository.save(planTwe);</span>
<span class="fc" id="L104">    String planUrl = &quot;/plans&quot;;</span>

<span class="fc" id="L106">    mockMvc.perform(get(planUrl)</span>
<span class="fc" id="L107">            .accept(MediaType.APPLICATION_JSON))</span>
<span class="fc" id="L108">        .andExpect(status().isOk())</span>
<span class="fc" id="L109">        .andExpect(jsonPath(&quot;$&quot;).isArray())</span>
<span class="fc" id="L110">        .andExpect(jsonPath(&quot;$.length()&quot;).value(2))</span>
<span class="fc" id="L111">        .andExpect(jsonPath(&quot;$[0].id&quot;).exists())</span>
<span class="fc" id="L112">        .andExpect(jsonPath(&quot;$[0].name&quot;).value(&quot;Speed of Light&quot;))</span>
<span class="fc" id="L113">        .andExpect(jsonPath(&quot;$[1].id&quot;).exists())</span>
<span class="fc" id="L114">        .andExpect(jsonPath(&quot;$[1].name&quot;).value(&quot;Low Connection&quot;));</span>
<span class="fc" id="L115">  }</span>

  @Test
  @DisplayName(&quot;Retrieval plan by id&quot;)
  public void testPlanRetrievalById() throws Exception {
<span class="fc" id="L120">    Plan plan = new Plan(&quot;Speed of Light&quot;, 299, 100.0);</span>

<span class="fc" id="L122">    planRepository.save(plan);</span>
<span class="fc" id="L123">    String planUrl = &quot;/plans/%s&quot;.formatted(plan.getId());</span>

<span class="fc" id="L125">    mockMvc.perform(get(planUrl)</span>
<span class="fc" id="L126">            .accept(MediaType.APPLICATION_JSON))</span>
<span class="fc" id="L127">        .andExpect(status().isOk())</span>
<span class="fc" id="L128">        .andExpect(jsonPath(&quot;$.id&quot;).exists())</span>
<span class="fc" id="L129">        .andExpect(jsonPath(&quot;$.name&quot;).value(&quot;Speed of Light&quot;))</span>
<span class="fc" id="L130">        .andExpect(jsonPath(&quot;$.speed&quot;).value(299))</span>
<span class="fc" id="L131">        .andExpect(jsonPath(&quot;$.price&quot;).value(100.0));</span>
<span class="fc" id="L132">  }</span>

  @Test
  @DisplayName(&quot;Throw planNotFoundException&quot;)
  public void testPlanNotFoundExceptionById() throws Exception {

<span class="fc" id="L138">    String planUrl = &quot;/plans/666&quot;;</span>

<span class="fc" id="L140">    mockMvc.perform(get(planUrl)</span>
<span class="fc" id="L141">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L142">            .accept(MediaType.APPLICATION_JSON))</span>
<span class="fc" id="L143">        .andExpect(status().isNotFound())</span>
<span class="fc" id="L144">        .andExpect(jsonPath(&quot;$.message&quot;).value(&quot;Plan not found with identifier 666!&quot;));</span>
<span class="fc" id="L145">  }</span>

  @Test
  @DisplayName(&quot;Create plan&quot;)
  public void testCreatePlan() throws Exception {

<span class="fc" id="L151">    Plan newPlan = new Plan(&quot;Speed of Light&quot;, 299, 100.0);</span>

<span class="fc" id="L153">    ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L154">    String newPlanJson = objectMapper.writeValueAsString(newPlan);</span>
<span class="fc" id="L155">    String planUrl = &quot;/plans&quot;;</span>

<span class="fc" id="L157">    mockMvc.perform(post(planUrl)</span>
<span class="fc" id="L158">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L159">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L160">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L161">            .content(newPlanJson))</span>
<span class="fc" id="L162">        .andExpect(status().isCreated())</span>
<span class="fc" id="L163">        .andExpect(jsonPath(&quot;$.id&quot;).exists())</span>
<span class="fc" id="L164">        .andExpect(jsonPath(&quot;$.name&quot;).value(&quot;Speed of Light&quot;))</span>
<span class="fc" id="L165">        .andExpect(jsonPath(&quot;$.speed&quot;).value(299))</span>
<span class="fc" id="L166">        .andExpect(jsonPath(&quot;$.price&quot;).value(100.0));</span>
<span class="fc" id="L167">  }</span>

  @Test
  @DisplayName(&quot;Update plan&quot;)
  public void testUpdatePlan() throws Exception {

<span class="fc" id="L173">    Plan planToUpdate = new Plan(&quot;Speed of Light&quot;, 299, 100.0);</span>
<span class="fc" id="L174">    planRepository.save(planToUpdate);</span>

<span class="fc" id="L176">    planToUpdate.setName(&quot;Speed of Thunder&quot;);</span>
<span class="fc" id="L177">    planToUpdate.setSpeed(150);</span>
<span class="fc" id="L178">    planToUpdate.setPrice(70.0);</span>

<span class="fc" id="L180">    ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L181">    String updatedPlanJson = objectMapper.writeValueAsString(planToUpdate);</span>
<span class="fc" id="L182">    String planUrl = &quot;/plans/%s&quot;.formatted(planToUpdate.getId());</span>

<span class="fc" id="L184">    mockMvc.perform(put(planUrl)</span>
<span class="fc" id="L185">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L186">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L187">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L188">            .content(updatedPlanJson))</span>
<span class="fc" id="L189">        .andExpect(status().isOk())</span>
<span class="fc" id="L190">        .andExpect(jsonPath(&quot;$.id&quot;).exists())</span>
<span class="fc" id="L191">        .andExpect(jsonPath(&quot;$.name&quot;).value(&quot;Speed of Thunder&quot;))</span>
<span class="fc" id="L192">        .andExpect(jsonPath(&quot;$.speed&quot;).value(150))</span>
<span class="fc" id="L193">        .andExpect(jsonPath(&quot;$.price&quot;).value(70.0));</span>
<span class="fc" id="L194">  }</span>

  @Test
  @DisplayName(&quot;Delete plan&quot;)
  public void testDeletePlan() throws Exception {

<span class="fc" id="L200">    Plan planToDelete = new Plan(&quot;Speed of Light&quot;, 299, 100.0);</span>
<span class="fc" id="L201">    planRepository.save(planToDelete);</span>

<span class="fc" id="L203">    String planUrl = &quot;/plans/%s&quot;.formatted(planToDelete.getId());</span>

<span class="fc" id="L205">    mockMvc.perform(delete(planUrl)</span>
<span class="fc" id="L206">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L207">            .accept(MediaType.APPLICATION_JSON))</span>
<span class="fc" id="L208">        .andExpect(status().isOk())</span>
<span class="fc" id="L209">        .andExpect(jsonPath(&quot;$.id&quot;).exists())</span>
<span class="fc" id="L210">        .andExpect(jsonPath(&quot;$.name&quot;).value(&quot;Speed of Light&quot;))</span>
<span class="fc" id="L211">        .andExpect(jsonPath(&quot;$.speed&quot;).value(299))</span>
<span class="fc" id="L212">        .andExpect(jsonPath(&quot;$.price&quot;).value(100.0));</span>
<span class="fc" id="L213">  }</span>

  @Test
  @DisplayName(&quot;Throw planCannotBeExcludedException&quot;)
  public void testPlanCannotBeExcludedException() throws Exception {

<span class="fc" id="L219">    Customer customer = new Customer(</span>
        &quot;Graciliano Ramos de Oliveira&quot;,
        &quot;00011122233&quot;,
        &quot;77011223344&quot;,
        &quot;gracit@example.com&quot;
    );

<span class="fc" id="L226">    Address home = new Address(</span>
<span class="fc" id="L227">        &quot;São Paulo&quot;, &quot;São Paulo&quot;, &quot;01000000&quot;, &quot;Avenida Paulista&quot;, 1023, &quot;Bela Vista&quot;,</span>
        &quot;Próximo ao Parque Trianon&quot;);

<span class="fc" id="L230">    Technician technician = new Technician(&quot;João Antônio Benevides Faria&quot;, &quot;77011114444&quot;,</span>
        &quot;joao@example.com&quot;);

<span class="fc" id="L233">    Plan plan = new Plan(&quot;Speed og Thunder&quot;, 300, 70.0);</span>

<span class="fc" id="L235">    Equipment router = new Equipment(EquipmentType.ROUTER, &quot;Asus RT-AC88U&quot;, &quot;SN035&quot;, &quot;Asus&quot;);</span>
<span class="fc" id="L236">    Equipment modem = new Equipment(EquipmentType.MODEM, &quot;Motorola MG7700&quot;, &quot;SN036&quot;, &quot;Motorola&quot;);</span>

<span class="fc" id="L238">    home.setCustomer(customer);</span>
<span class="fc" id="L239">    customerRepository.save(customer);</span>
<span class="fc" id="L240">    addressRepository.save(home);</span>
<span class="fc" id="L241">    technicianRepository.save(technician);</span>
<span class="fc" id="L242">    planRepository.save(plan);</span>
<span class="fc" id="L243">    equipmentRepository.save(router);</span>
<span class="fc" id="L244">    equipmentRepository.save(modem);</span>

<span class="fc" id="L246">    List&lt;Equipment&gt; equipmentList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L247">    equipmentList.add(router);</span>
<span class="fc" id="L248">    equipmentList.add(modem);</span>

<span class="fc" id="L250">    Installation installation = new Installation(home, plan, technician, equipmentList);</span>

<span class="fc" id="L252">    installationRepository.save(installation);</span>

<span class="fc" id="L254">    String planUrl = &quot;/plans/%s&quot;.formatted(plan.getId());</span>

<span class="fc" id="L256">    mockMvc.perform(delete(planUrl)</span>
<span class="fc" id="L257">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L258">            .accept(MediaType.APPLICATION_JSON))</span>
<span class="fc" id="L259">        .andExpect(status().isConflict())</span>
<span class="fc" id="L260">        .andExpect(jsonPath(&quot;$.message&quot;).value(</span>
            &quot;This Plan cannot be excluded because it has an association!&quot;));
<span class="fc" id="L262">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
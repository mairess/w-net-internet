<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AddressIntegrationTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in w-net-internet Coverage Results</a> &gt; <a href="index.source.html" class="el_package">com.maires.wnet.integration</a> &gt; <span class="el_source">AddressIntegrationTest.java</span></div><h1>AddressIntegrationTest.java</h1><pre class="source lang-java linenums">package com.maires.wnet.integration;

import static org.hamcrest.Matchers.nullValue;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.put;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.maires.wnet.controller.dto.InstallationCreationDto;
import com.maires.wnet.entity.Address;
import com.maires.wnet.entity.Customer;
import com.maires.wnet.entity.Equipment;
import com.maires.wnet.entity.EquipmentType;
import com.maires.wnet.entity.Installation;
import com.maires.wnet.entity.Plan;
import com.maires.wnet.entity.Technician;
import com.maires.wnet.entity.User;
import com.maires.wnet.repository.AddressRepository;
import com.maires.wnet.repository.CustomerRepository;
import com.maires.wnet.repository.EquipmentRepository;
import com.maires.wnet.repository.InstallationRepository;
import com.maires.wnet.repository.PlanRepository;
import com.maires.wnet.repository.TechnicianRepository;
import com.maires.wnet.repository.UserRepository;
import com.maires.wnet.security.Role;
import com.maires.wnet.service.TokenService;
import java.util.ArrayList;
import java.util.List;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.test.context.DynamicPropertyRegistry;
import org.springframework.test.context.DynamicPropertySource;
import org.springframework.test.web.servlet.MockMvc;
import org.testcontainers.containers.KafkaContainer;
import org.testcontainers.containers.PostgreSQLContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;

@SpringBootTest
@AutoConfigureMockMvc
@Testcontainers
@DisplayName(&quot;Address integration tests&quot;)
<span class="fc" id="L52">public class AddressIntegrationTest {</span>

  @Container
<span class="fc" id="L55">  public static PostgreSQLContainer POSTGRES_CONTAINER = new PostgreSQLContainer(&quot;postgres&quot;)</span>
<span class="fc" id="L56">      .withDatabaseName(&quot;wnetdb&quot;);</span>
  @Container
<span class="fc" id="L58">  public static KafkaContainer KAFKA_CONTAINER = new KafkaContainer();</span>
  @Autowired
  AddressRepository addressRepository;
  @Autowired
  TechnicianRepository technicianRepository;
  @Autowired
  EquipmentRepository equipmentRepository;
  @Autowired
  PlanRepository planRepository;
  @Autowired
  UserRepository userRepository;
  @Autowired
  CustomerRepository customerRepository;
  @Autowired
  InstallationRepository installationRepository;
  @Autowired
  MockMvc mockMvc;
  @Autowired
  private TokenService tokenService;
  private String tokenAdmin;

  @DynamicPropertySource
  public static void overrideProperties(DynamicPropertyRegistry registry) {
<span class="fc" id="L81">    registry.add(&quot;spring.datasource.url&quot;, POSTGRES_CONTAINER::getJdbcUrl);</span>
<span class="fc" id="L82">    registry.add(&quot;spring.datasource.username&quot;, POSTGRES_CONTAINER::getUsername);</span>
<span class="fc" id="L83">    registry.add(&quot;spring.datasource.password&quot;, POSTGRES_CONTAINER::getPassword);</span>
<span class="fc" id="L84">    registry.add(&quot;spring.kafka.bootstrap-servers&quot;, KAFKA_CONTAINER::getBootstrapServers);</span>
<span class="fc" id="L85">  }</span>

  @BeforeEach
  public void cleanUp() {
<span class="fc" id="L89">    userRepository.deleteAll();</span>
<span class="fc" id="L90">    equipmentRepository.deleteAll();</span>
<span class="fc" id="L91">    addressRepository.deleteAll();</span>
<span class="fc" id="L92">    customerRepository.deleteAll();</span>
<span class="fc" id="L93">    technicianRepository.deleteAll();</span>
<span class="fc" id="L94">    planRepository.deleteAll();</span>
<span class="fc" id="L95">    User admin = new User(null, &quot;System Manager Administrator&quot;, &quot;admin@mail.com&quot;, &quot;admin&quot;,</span>
        &quot;segredo123&quot;,
        Role.ADMIN);
<span class="fc" id="L98">    User userAdmin = userRepository.save(admin);</span>
<span class="fc" id="L99">    tokenAdmin = tokenService.generateToken(userAdmin.getUsername());</span>
<span class="fc" id="L100">  }</span>

  @Test
  @DisplayName(&quot;Retrieval all addresses&quot;)
  public void testAddressRetrievalAll() throws Exception {
<span class="fc" id="L105">    Address home = new Address(</span>
        &quot;São Paulo&quot;,
        &quot;São Paulo&quot;,
        &quot;01000000&quot;,
        &quot;Avenida Paulista&quot;,
<span class="fc" id="L110">        1023,</span>
        &quot;Próximo ao Parque Trianon&quot;,
        &quot;Bela Vista&quot;
    );

<span class="fc" id="L115">    Address work = new Address(</span>
        &quot;São Paulo&quot;,
        &quot;São Paulo&quot;,
        &quot;13000000&quot;,
        &quot;Fazenda Santo Antônio&quot;,
        null,
        &quot;Próximo ao Lago Azul&quot;,
        &quot;Zona Rural&quot;
    );

<span class="fc" id="L125">    addressRepository.save(home);</span>
<span class="fc" id="L126">    addressRepository.save(work);</span>
<span class="fc" id="L127">    String addressUrl = &quot;/addresses&quot;;</span>

<span class="fc" id="L129">    mockMvc.perform(get(addressUrl)</span>
<span class="fc" id="L130">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L131">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin))</span>
<span class="fc" id="L132">        .andExpect(status().isOk())</span>
<span class="fc" id="L133">        .andExpect(jsonPath(&quot;$&quot;).isArray())</span>
<span class="fc" id="L134">        .andExpect(jsonPath(&quot;$.length()&quot;).value(2))</span>
<span class="fc" id="L135">        .andExpect(jsonPath(&quot;$[0].street&quot;).value(&quot;Avenida Paulista&quot;))</span>
<span class="fc" id="L136">        .andExpect(jsonPath(&quot;$[0].streetNumber&quot;).value(1023))</span>
<span class="fc" id="L137">        .andExpect(jsonPath(&quot;$[1].street&quot;).value(&quot;Fazenda Santo Antônio&quot;))</span>
<span class="fc" id="L138">        .andExpect(jsonPath(&quot;$[1].streetNumber&quot;).value(nullValue()));</span>
<span class="fc" id="L139">  }</span>

  @Test
  @DisplayName(&quot;Retrieval addresses by id&quot;)
  public void testAddressRetrievalById() throws Exception {
<span class="fc" id="L144">    Address home = new Address(</span>
        &quot;São Paulo&quot;,
        &quot;São Paulo&quot;,
        &quot;01000000&quot;,
        &quot;Avenida Paulista&quot;,
<span class="fc" id="L149">        1023,</span>
        &quot;Bela Vista&quot;,
        &quot;Próximo ao Parque Trianon&quot;
    );

<span class="fc" id="L154">    addressRepository.save(home);</span>
<span class="fc" id="L155">    String addressUrl = &quot;/addresses/%s&quot;.formatted(home.getId());</span>

<span class="fc" id="L157">    mockMvc.perform(get(addressUrl)</span>
<span class="fc" id="L158">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L159">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin))</span>
<span class="fc" id="L160">        .andExpect(status().isOk())</span>
<span class="fc" id="L161">        .andExpect(jsonPath(&quot;$.id&quot;).exists())</span>
<span class="fc" id="L162">        .andExpect(jsonPath(&quot;$.city&quot;).value(&quot;São Paulo&quot;))</span>
<span class="fc" id="L163">        .andExpect(jsonPath(&quot;$.state&quot;).value(&quot;São Paulo&quot;))</span>
<span class="fc" id="L164">        .andExpect(jsonPath(&quot;$.zipCode&quot;).value(&quot;01000000&quot;))</span>
<span class="fc" id="L165">        .andExpect(jsonPath(&quot;$.street&quot;).value(&quot;Avenida Paulista&quot;))</span>
<span class="fc" id="L166">        .andExpect(jsonPath(&quot;$.streetNumber&quot;).value(1023))</span>
<span class="fc" id="L167">        .andExpect(jsonPath(&quot;$.neighborhood&quot;).value(&quot;Bela Vista&quot;))</span>
<span class="fc" id="L168">        .andExpect(jsonPath(&quot;$.complement&quot;).value(&quot;Próximo ao Parque Trianon&quot;));</span>
<span class="fc" id="L169">  }</span>

  @Test
  @DisplayName(&quot;Throw addressNotFoundException by id&quot;)
  public void testAddressNotFoundExceptionById() throws Exception {

<span class="fc" id="L175">    String addressUrl = &quot;/addresses/666&quot;;</span>

<span class="fc" id="L177">    mockMvc.perform(get(addressUrl)</span>
<span class="fc" id="L178">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L179">            .accept(MediaType.APPLICATION_JSON))</span>
<span class="fc" id="L180">        .andExpect(status().isNotFound())</span>
<span class="fc" id="L181">        .andExpect(jsonPath(&quot;$.message&quot;).value(&quot;Address not found with identifier 666!&quot;));</span>
<span class="fc" id="L182">  }</span>

  @Test
  @DisplayName(&quot;Create address installation&quot;)
  public void testCreateAddressInstallation() throws Exception {

<span class="fc" id="L188">    Customer customer = new Customer(</span>
        &quot;Graciliano Ramos de Oliveira&quot;,
        &quot;00011122233&quot;,
        &quot;77011223344&quot;,
        &quot;gracit@example.com&quot;
    );

<span class="fc" id="L195">    Address home = new Address(</span>
<span class="fc" id="L196">        &quot;São Paulo&quot;, &quot;São Paulo&quot;, &quot;01000000&quot;, &quot;Avenida Paulista&quot;, 1023, &quot;Bela Vista&quot;,</span>
        &quot;Próximo ao Parque Trianon&quot;);

<span class="fc" id="L199">    Technician technician = new Technician(&quot;João Antônio Benevides Faria&quot;, &quot;77011114444&quot;,</span>
        &quot;joao@example.com&quot;);

<span class="fc" id="L202">    Plan plan = new Plan(&quot;Speed og Thunder&quot;, 300, 70.0);</span>

<span class="fc" id="L204">    Equipment router = new Equipment(EquipmentType.ROUTER, &quot;Asus RT-AC88U&quot;, &quot;SN035&quot;, &quot;Asus&quot;);</span>
<span class="fc" id="L205">    Equipment modem = new Equipment(EquipmentType.MODEM, &quot;Motorola MG7700&quot;, &quot;SN036&quot;, &quot;Motorola&quot;);</span>

<span class="fc" id="L207">    home.setCustomer(customer);</span>
<span class="fc" id="L208">    customerRepository.save(customer);</span>
<span class="fc" id="L209">    addressRepository.save(home);</span>
<span class="fc" id="L210">    technicianRepository.save(technician);</span>
<span class="fc" id="L211">    planRepository.save(plan);</span>
<span class="fc" id="L212">    equipmentRepository.save(router);</span>
<span class="fc" id="L213">    equipmentRepository.save(modem);</span>

<span class="fc" id="L215">    List&lt;Long&gt; equipmentList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L216">    equipmentList.add(router.getId());</span>
<span class="fc" id="L217">    equipmentList.add(modem.getId());</span>

<span class="fc" id="L219">    InstallationCreationDto installationDto = new InstallationCreationDto(plan.getId(),</span>
<span class="fc" id="L220">        technician.getId(), equipmentList);</span>

<span class="fc" id="L222">    ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L223">    String newInstallationJson = objectMapper.writeValueAsString(installationDto);</span>
<span class="fc" id="L224">    String addressUrl = &quot;/addresses/%s/installations&quot;.formatted(home.getId());</span>

<span class="fc" id="L226">    mockMvc.perform(post(addressUrl)</span>
<span class="fc" id="L227">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L228">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L229">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L230">            .content(newInstallationJson))</span>
<span class="fc" id="L231">        .andExpect(status().isCreated());</span>
<span class="fc" id="L232">  }</span>

  @Test
  @DisplayName(&quot;Throw AddressAlreadyAssociatedException&quot;)
  public void testAddressAlreadyAssociatedException() throws Exception {

<span class="fc" id="L238">    Address address = new Address(</span>
<span class="fc" id="L239">        &quot;São Paulo&quot;, &quot;São Paulo&quot;, &quot;01000000&quot;, &quot;Avenida Paulista&quot;, 1023, &quot;Bela Vista&quot;,</span>
        &quot;Próximo ao Parque Trianon&quot;);

<span class="fc" id="L242">    Technician technician = new Technician(&quot;João Antônio Benevides Faria&quot;, &quot;77011114444&quot;,</span>
        &quot;joao@example.com&quot;);

<span class="fc" id="L245">    Plan plan = new Plan(&quot;Speed og Thunder&quot;, 300, 70.0);</span>

<span class="fc" id="L247">    Equipment router = new Equipment(EquipmentType.ROUTER, &quot;Asus RT-AC88U&quot;, &quot;SN035&quot;, &quot;Asus&quot;);</span>
<span class="fc" id="L248">    Equipment modem = new Equipment(EquipmentType.MODEM, &quot;Motorola MG7700&quot;, &quot;SN036&quot;, &quot;Motorola&quot;);</span>

<span class="fc" id="L250">    Installation installation = new Installation();</span>

<span class="fc" id="L252">    address.setInstallation(installation);</span>
<span class="fc" id="L253">    addressRepository.save(address);</span>

<span class="fc" id="L255">    List&lt;Long&gt; equipmentList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L256">    equipmentList.add(router.getId());</span>
<span class="fc" id="L257">    equipmentList.add(modem.getId());</span>

<span class="fc" id="L259">    InstallationCreationDto installationDto = new InstallationCreationDto(plan.getId(),</span>
<span class="fc" id="L260">        technician.getId(), equipmentList);</span>

<span class="fc" id="L262">    ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L263">    String newInstallationJson = objectMapper.writeValueAsString(installationDto);</span>
<span class="fc" id="L264">    String addressUrl = &quot;/addresses/%s/installations&quot;.formatted(address.getId());</span>

<span class="fc" id="L266">    mockMvc.perform(post(addressUrl)</span>
<span class="fc" id="L267">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L268">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L269">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L270">            .content(newInstallationJson))</span>
<span class="fc" id="L271">        .andExpect(status().isConflict())</span>
<span class="fc" id="L272">        .andExpect(jsonPath(&quot;$.message&quot;).value(&quot;This address is already associated!&quot;));</span>
<span class="fc" id="L273">  }</span>

  @Test
  @DisplayName(&quot;Throw EquipmentAlreadyAssociatedException&quot;)
  public void testEquipmentAlreadyAssociatedException() throws Exception {

<span class="fc" id="L279">    Customer customer = new Customer(</span>
        &quot;Graciliano Ramos de Oliveira&quot;,
        &quot;00011122233&quot;,
        &quot;77011223344&quot;,
        &quot;gracit@example.com&quot;
    );

<span class="fc" id="L286">    customerRepository.save(customer);</span>

<span class="fc" id="L288">    Address address = new Address(</span>
<span class="fc" id="L289">        &quot;São Paulo&quot;, &quot;São Paulo&quot;, &quot;01000000&quot;, &quot;Avenida Paulista&quot;, 1023, &quot;Bela Vista&quot;,</span>
        &quot;Próximo ao Parque Trianon&quot;);

<span class="fc" id="L292">    Technician technician = new Technician(&quot;João Antônio Benevides Faria&quot;, &quot;77011114444&quot;,</span>
        &quot;joao@example.com&quot;);
<span class="fc" id="L294">    technicianRepository.save(technician);</span>

<span class="fc" id="L296">    Plan plan = new Plan(&quot;Speed og Thunder&quot;, 300, 70.0);</span>
<span class="fc" id="L297">    planRepository.save(plan);</span>

<span class="fc" id="L299">    Equipment router = new Equipment(EquipmentType.ROUTER, &quot;Asus RT-AC88U&quot;, &quot;SN035&quot;, &quot;Asus&quot;);</span>
<span class="fc" id="L300">    Equipment modem = new Equipment(EquipmentType.MODEM, &quot;Motorola MG7700&quot;, &quot;SN036&quot;, &quot;Motorola&quot;);</span>

<span class="fc" id="L302">    address.setCustomer(customer);</span>
<span class="fc" id="L303">    addressRepository.save(address);</span>

<span class="fc" id="L305">    Installation installation = new Installation();</span>

<span class="fc" id="L307">    installationRepository.save(installation);</span>

<span class="fc" id="L309">    router.setInstallation(installation);</span>
<span class="fc" id="L310">    modem.setInstallation(installation);</span>
<span class="fc" id="L311">    equipmentRepository.save(router);</span>
<span class="fc" id="L312">    equipmentRepository.save(modem);</span>

<span class="fc" id="L314">    List&lt;Long&gt; equipmentList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L315">    equipmentList.add(router.getId());</span>
<span class="fc" id="L316">    equipmentList.add(modem.getId());</span>

<span class="fc" id="L318">    InstallationCreationDto installationDto = new InstallationCreationDto(plan.getId(),</span>
<span class="fc" id="L319">        technician.getId(), equipmentList);</span>

<span class="fc" id="L321">    ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L322">    String newInstallationJson = objectMapper.writeValueAsString(installationDto);</span>
<span class="fc" id="L323">    String addressUrl = &quot;/addresses/%s/installations&quot;.formatted(address.getId());</span>

<span class="fc" id="L325">    mockMvc.perform(post(addressUrl)</span>
<span class="fc" id="L326">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L327">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L328">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L329">            .content(newInstallationJson))</span>
<span class="fc" id="L330">        .andExpect(status().isConflict())</span>
<span class="fc" id="L331">        .andExpect(jsonPath(&quot;$.message&quot;).value(&quot;This equipment is already associated!&quot;));</span>
<span class="fc" id="L332">  }</span>

  @Test
  @DisplayName(&quot;Throw AddressNotFoundException by creating installation&quot;)
  public void testAddressNotFoundExceptionByCreatingInstallation() throws Exception {

<span class="fc" id="L338">    Technician technician = new Technician(&quot;João Antônio Benevides Faria&quot;, &quot;77011114444&quot;,</span>
        &quot;joao@example.com&quot;);
<span class="fc" id="L340">    technicianRepository.save(technician);</span>

<span class="fc" id="L342">    Plan plan = new Plan(&quot;Speed og Thunder&quot;, 300, 70.0);</span>
<span class="fc" id="L343">    planRepository.save(plan);</span>

<span class="fc" id="L345">    List&lt;Long&gt; equipmentList = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L347">    InstallationCreationDto installationDto = new InstallationCreationDto(plan.getId(),</span>
<span class="fc" id="L348">        technician.getId(), equipmentList);</span>

<span class="fc" id="L350">    ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L351">    String newInstallationJson = objectMapper.writeValueAsString(installationDto);</span>
<span class="fc" id="L352">    String addressUrl = &quot;/addresses/666/installations&quot;;</span>

<span class="fc" id="L354">    mockMvc.perform(post(addressUrl)</span>
<span class="fc" id="L355">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L356">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L357">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L358">            .content(newInstallationJson))</span>
<span class="fc" id="L359">        .andExpect(status().isNotFound())</span>
<span class="fc" id="L360">        .andExpect(jsonPath(&quot;$.message&quot;).value(&quot;Address not found with identifier 666!&quot;));</span>
<span class="fc" id="L361">  }</span>

  @Test
  @DisplayName(&quot;Throw PlanNotFoundException by creating installation&quot;)
  public void testPlanNotFoundExceptionByCreatingInstallation() throws Exception {

<span class="fc" id="L367">    Address address = new Address(</span>
<span class="fc" id="L368">        &quot;São Paulo&quot;, &quot;São Paulo&quot;, &quot;01000000&quot;, &quot;Avenida Paulista&quot;, 1023, &quot;Bela Vista&quot;,</span>
        &quot;Próximo ao Parque Trianon&quot;);
<span class="fc" id="L370">    addressRepository.save(address);</span>

<span class="fc" id="L372">    Technician technician = new Technician(&quot;João Antônio Benevides Faria&quot;, &quot;77011114444&quot;,</span>
        &quot;joao@example.com&quot;);
<span class="fc" id="L374">    technicianRepository.save(technician);</span>

<span class="fc" id="L376">    List&lt;Long&gt; equipmentList = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L378">    InstallationCreationDto installationDto = new InstallationCreationDto(666L,</span>
<span class="fc" id="L379">        technician.getId(), equipmentList);</span>

<span class="fc" id="L381">    ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L382">    String newInstallationJson = objectMapper.writeValueAsString(installationDto);</span>
<span class="fc" id="L383">    String addressUrl = &quot;/addresses/%s/installations&quot;.formatted(address.getId());</span>

<span class="fc" id="L385">    mockMvc.perform(post(addressUrl)</span>
<span class="fc" id="L386">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L387">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L388">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L389">            .content(newInstallationJson))</span>
<span class="fc" id="L390">        .andExpect(status().isNotFound())</span>
<span class="fc" id="L391">        .andExpect(jsonPath(&quot;$.message&quot;).value(&quot;Plan not found with identifier 666!&quot;));</span>
<span class="fc" id="L392">  }</span>

  @Test
  @DisplayName(&quot;Throw TechnicianNotFoundException by creating installation&quot;)
  public void testTechnicianNotFoundExceptionByCreatingInstallation() throws Exception {

<span class="fc" id="L398">    Address address = new Address(</span>
<span class="fc" id="L399">        &quot;São Paulo&quot;, &quot;São Paulo&quot;, &quot;01000000&quot;, &quot;Avenida Paulista&quot;, 1023, &quot;Bela Vista&quot;,</span>
        &quot;Próximo ao Parque Trianon&quot;);
<span class="fc" id="L401">    addressRepository.save(address);</span>

<span class="fc" id="L403">    Plan plan = new Plan(&quot;Speed og Thunder&quot;, 300, 70.0);</span>
<span class="fc" id="L404">    planRepository.save(plan);</span>

<span class="fc" id="L406">    List&lt;Long&gt; equipmentList = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L408">    InstallationCreationDto installationDto = new InstallationCreationDto(plan.getId(),</span>
<span class="fc" id="L409">        666L, equipmentList);</span>

<span class="fc" id="L411">    ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L412">    String newInstallationJson = objectMapper.writeValueAsString(installationDto);</span>
<span class="fc" id="L413">    String addressUrl = &quot;/addresses/%s/installations&quot;.formatted(address.getId());</span>

<span class="fc" id="L415">    mockMvc.perform(post(addressUrl)</span>
<span class="fc" id="L416">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L417">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L418">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L419">            .content(newInstallationJson))</span>
<span class="fc" id="L420">        .andExpect(status().isNotFound())</span>
<span class="fc" id="L421">        .andExpect(jsonPath(&quot;$.message&quot;).value(&quot;Technician not found with identifier 666!&quot;));</span>
<span class="fc" id="L422">  }</span>

  @Test
  @DisplayName(&quot;Throw EquipmentNotFoundException by creating installation&quot;)
  public void testEquipmentNotFoundExceptionByCreatingInstallation() throws Exception {

<span class="fc" id="L428">    Address address = new Address(</span>
<span class="fc" id="L429">        &quot;São Paulo&quot;, &quot;São Paulo&quot;, &quot;01000000&quot;, &quot;Avenida Paulista&quot;, 1023, &quot;Bela Vista&quot;,</span>
        &quot;Próximo ao Parque Trianon&quot;);
<span class="fc" id="L431">    addressRepository.save(address);</span>

<span class="fc" id="L433">    Plan plan = new Plan(&quot;Speed og Thunder&quot;, 300, 70.0);</span>
<span class="fc" id="L434">    planRepository.save(plan);</span>

<span class="fc" id="L436">    Technician technician = new Technician(&quot;João Antônio Benevides Faria&quot;, &quot;77011114444&quot;,</span>
        &quot;joao@example.com&quot;);
<span class="fc" id="L438">    technicianRepository.save(technician);</span>

<span class="fc" id="L440">    List&lt;Long&gt; equipmentList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L441">    equipmentList.add(666L);</span>

<span class="fc" id="L443">    InstallationCreationDto installationDto = new InstallationCreationDto(plan.getId(),</span>
<span class="fc" id="L444">        technician.getId(), equipmentList);</span>

<span class="fc" id="L446">    ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L447">    String newInstallationJson = objectMapper.writeValueAsString(installationDto);</span>
<span class="fc" id="L448">    String addressUrl = &quot;/addresses/%s/installations&quot;.formatted(address.getId());</span>

<span class="fc" id="L450">    mockMvc.perform(post(addressUrl)</span>
<span class="fc" id="L451">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L452">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L453">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L454">            .content(newInstallationJson))</span>
<span class="fc" id="L455">        .andExpect(status().isNotFound())</span>
<span class="fc" id="L456">        .andExpect(jsonPath(&quot;$.message&quot;).value(&quot;Equipment not found with identifier 666!&quot;));</span>
<span class="fc" id="L457">  }</span>

  @Test
  @DisplayName(&quot;Update address&quot;)
  public void testUpdateAddress() throws Exception {

<span class="fc" id="L463">    Address addressToUpdate = new Address(</span>
<span class="fc" id="L464">        &quot;São Paulo&quot;, &quot;São Paulo&quot;, &quot;01000000&quot;, &quot;Avenida Paulista&quot;, 1023, &quot;Bela Vista&quot;,</span>
        &quot;Próximo ao Parque Trianon&quot;);

<span class="fc" id="L467">    addressRepository.save(addressToUpdate);</span>

<span class="fc" id="L469">    addressToUpdate.setCity(&quot;Guarulhos&quot;);</span>
<span class="fc" id="L470">    addressToUpdate.setZipCode(&quot;11111111&quot;);</span>
<span class="fc" id="L471">    addressToUpdate.setStreet(&quot;Rua das Flores&quot;);</span>
<span class="fc" id="L472">    addressToUpdate.setStreetNumber(41);</span>
<span class="fc" id="L473">    addressToUpdate.setNeighborhood(&quot;Jardim Verde&quot;);</span>

<span class="fc" id="L475">    ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L476">    String updatedAddressJson = objectMapper.writeValueAsString(addressToUpdate);</span>
<span class="fc" id="L477">    String addressUrl = &quot;/addresses/%s&quot;.formatted(addressToUpdate.getId());</span>

<span class="fc" id="L479">    mockMvc.perform(put(addressUrl)</span>
<span class="fc" id="L480">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L481">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L482">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L483">            .content(updatedAddressJson))</span>
<span class="fc" id="L484">        .andExpect(status().isOk())</span>
<span class="fc" id="L485">        .andExpect(jsonPath(&quot;$.id&quot;).exists())</span>
<span class="fc" id="L486">        .andExpect(jsonPath(&quot;$.city&quot;).value(&quot;Guarulhos&quot;))</span>
<span class="fc" id="L487">        .andExpect(jsonPath(&quot;$.zipCode&quot;).value(&quot;11111111&quot;))</span>
<span class="fc" id="L488">        .andExpect(jsonPath(&quot;$.street&quot;).value(&quot;Rua das Flores&quot;))</span>
<span class="fc" id="L489">        .andExpect(jsonPath(&quot;$.streetNumber&quot;).value(41))</span>
<span class="fc" id="L490">        .andExpect(jsonPath(&quot;$.neighborhood&quot;).value(&quot;Jardim Verde&quot;));</span>
<span class="fc" id="L491">  }</span>

  @Test
  @DisplayName(&quot;Delete Address&quot;)
  public void testDeleteAddress() throws Exception {

//    Address addressToDelete = new Address(
//        &quot;São Paulo&quot;, &quot;São Paulo&quot;, &quot;01000000&quot;, &quot;Avenida Paulista&quot;, 1023, &quot;Bela Vista&quot;,
//        &quot;Próximo ao Parque Trianon&quot;);
//
//    addressRepository.save(addressToDelete);
//
//    String addressUrl = &quot;/addresses/%s&quot;.formatted(addressToDelete.getId());
//
//    mockMvc.perform(delete(addressUrl)
//            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)
//            .accept(MediaType.APPLICATION_JSON))
//        .andExpect(status().isOk())
//        .andExpect(jsonPath(&quot;$.id&quot;).exists())
//        .andExpect(jsonPath(&quot;$.city&quot;).value(&quot;São Paulo&quot;))
//        .andExpect(jsonPath(&quot;$.zipCode&quot;).value(&quot;01000000&quot;))
//        .andExpect(jsonPath(&quot;$.street&quot;).value(&quot;Avenida Paulista&quot;))
//        .andExpect(jsonPath(&quot;$.streetNumber&quot;).value(1023))
//        .andExpect(jsonPath(&quot;$.neighborhood&quot;).value(&quot;Bela Vista&quot;))
//        .andExpect(jsonPath(&quot;$.complement&quot;).value(&quot;Próximo ao Parque Trianon&quot;));

<span class="fc" id="L517">    Customer customer = new Customer(</span>
        &quot;Graciliano Ramos de Oliveira&quot;,
        &quot;00011122233&quot;,
        &quot;77011223344&quot;,
        &quot;gracit@example.com&quot;
    );

<span class="fc" id="L524">    Address addressToDelete = new Address(</span>
<span class="fc" id="L525">        &quot;São Paulo&quot;, &quot;São Paulo&quot;, &quot;01000000&quot;, &quot;Avenida Paulista&quot;, 1023, &quot;Bela Vista&quot;,</span>
        &quot;Próximo ao Parque Trianon&quot;);

<span class="fc" id="L528">    Technician technician = new Technician(&quot;João Antônio Benevides Faria&quot;, &quot;77011114444&quot;,</span>
        &quot;joao@example.com&quot;);

<span class="fc" id="L531">    Plan plan = new Plan(&quot;Speed og Thunder&quot;, 300, 70.0);</span>

<span class="fc" id="L533">    Equipment router = new Equipment(EquipmentType.ROUTER, &quot;Asus RT-AC88U&quot;, &quot;SN035&quot;, &quot;Asus&quot;);</span>
<span class="fc" id="L534">    Equipment modem = new Equipment(EquipmentType.MODEM, &quot;Motorola MG7700&quot;, &quot;SN036&quot;, &quot;Motorola&quot;);</span>

<span class="fc" id="L536">    addressToDelete.setCustomer(customer);</span>
<span class="fc" id="L537">    customerRepository.save(customer);</span>
<span class="fc" id="L538">    addressRepository.save(addressToDelete);</span>
<span class="fc" id="L539">    technicianRepository.save(technician);</span>
<span class="fc" id="L540">    planRepository.save(plan);</span>
<span class="fc" id="L541">    equipmentRepository.save(router);</span>
<span class="fc" id="L542">    equipmentRepository.save(modem);</span>

<span class="fc" id="L544">    List&lt;Long&gt; equipmentList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L545">    equipmentList.add(router.getId());</span>
<span class="fc" id="L546">    equipmentList.add(modem.getId());</span>

<span class="fc" id="L548">    InstallationCreationDto installationDto = new InstallationCreationDto(plan.getId(),</span>
<span class="fc" id="L549">        technician.getId(), equipmentList);</span>

<span class="fc" id="L551">    ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L552">    String newInstallationJson = objectMapper.writeValueAsString(installationDto);</span>
<span class="fc" id="L553">    String addressUrl = &quot;/addresses/%s&quot;.formatted(addressToDelete.getId());</span>

<span class="fc" id="L555">    mockMvc.perform(delete(addressUrl)</span>
<span class="fc" id="L556">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L557">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L558">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L559">            .content(newInstallationJson))</span>
<span class="fc" id="L560">        .andExpect(status().isOk());</span>
<span class="fc" id="L561">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
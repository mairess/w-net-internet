<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InstallationIntegrationTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in w-net-internet Coverage Results</a> &gt; <a href="index.source.html" class="el_package">com.maires.wnet.integration</a> &gt; <span class="el_source">InstallationIntegrationTest.java</span></div><h1>InstallationIntegrationTest.java</h1><pre class="source lang-java linenums">package com.maires.wnet.integration;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.put;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.maires.wnet.controller.dto.InstallationCreationDto;
import com.maires.wnet.entity.Address;
import com.maires.wnet.entity.Equipment;
import com.maires.wnet.entity.EquipmentType;
import com.maires.wnet.entity.Installation;
import com.maires.wnet.entity.Plan;
import com.maires.wnet.entity.Technician;
import com.maires.wnet.entity.User;
import com.maires.wnet.repository.AddressRepository;
import com.maires.wnet.repository.CustomerRepository;
import com.maires.wnet.repository.EquipmentRepository;
import com.maires.wnet.repository.InstallationRepository;
import com.maires.wnet.repository.PlanRepository;
import com.maires.wnet.repository.TechnicianRepository;
import com.maires.wnet.repository.UserRepository;
import com.maires.wnet.security.Role;
import com.maires.wnet.service.TokenService;
import java.util.ArrayList;
import java.util.List;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.test.context.DynamicPropertyRegistry;
import org.springframework.test.context.DynamicPropertySource;
import org.springframework.test.web.servlet.MockMvc;
import org.testcontainers.containers.KafkaContainer;
import org.testcontainers.containers.PostgreSQLContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;

@SpringBootTest
@AutoConfigureMockMvc
@Testcontainers
@DisplayName(&quot;Installation integration tests&quot;)
<span class="fc" id="L49">public class InstallationIntegrationTest {</span>

  @Container
<span class="fc" id="L52">  public static PostgreSQLContainer POSTGRES_CONTAINER = new PostgreSQLContainer(&quot;postgres&quot;)</span>
<span class="fc" id="L53">      .withDatabaseName(&quot;wnetdb&quot;);</span>
  @Container
<span class="fc" id="L55">  public static KafkaContainer KAFKA_CONTAINER = new KafkaContainer();</span>
  @Autowired
  PlanRepository planRepository;
  @Autowired
  UserRepository userRepository;
  @Autowired
  InstallationRepository installationRepository;
  @Autowired
  CustomerRepository customerRepository;
  @Autowired
  TechnicianRepository technicianRepository;
  @Autowired
  AddressRepository addressRepository;
  @Autowired
  EquipmentRepository equipmentRepository;
  @Autowired
  MockMvc mockMvc;
  @Autowired
  private TokenService tokenService;
  private String tokenAdmin;

  @DynamicPropertySource
  public static void overrideProperties(DynamicPropertyRegistry registry) {
<span class="fc" id="L78">    registry.add(&quot;spring.datasource.url&quot;, POSTGRES_CONTAINER::getJdbcUrl);</span>
<span class="fc" id="L79">    registry.add(&quot;spring.datasource.username&quot;, POSTGRES_CONTAINER::getUsername);</span>
<span class="fc" id="L80">    registry.add(&quot;spring.datasource.password&quot;, POSTGRES_CONTAINER::getPassword);</span>
<span class="fc" id="L81">    registry.add(&quot;spring.kafka.bootstrap-servers&quot;, KAFKA_CONTAINER::getBootstrapServers);</span>
<span class="fc" id="L82">  }</span>

  @BeforeEach
  public void cleanUp() {
<span class="fc" id="L86">    userRepository.deleteAll();</span>
<span class="fc" id="L87">    installationRepository.deleteAll();</span>
<span class="fc" id="L88">    technicianRepository.deleteAll();</span>
<span class="fc" id="L89">    planRepository.deleteAll();</span>
<span class="fc" id="L90">    equipmentRepository.deleteAll();</span>
<span class="fc" id="L91">    User admin = new User(null, &quot;System Manager Administrator&quot;, &quot;admin@mail.com&quot;, &quot;admin&quot;,</span>
        &quot;segredo123&quot;,
        Role.ADMIN);
<span class="fc" id="L94">    User userAdmin = userRepository.save(admin);</span>
<span class="fc" id="L95">    tokenAdmin = tokenService.generateToken(userAdmin.getUsername());</span>
<span class="fc" id="L96">  }</span>

  @Test
  @DisplayName(&quot;Retrieval all installations&quot;)
  public void testInstallationRetrievalAll() throws Exception {

<span class="fc" id="L102">    Address home = new Address(</span>
<span class="fc" id="L103">        &quot;São Paulo&quot;, &quot;São Paulo&quot;, &quot;01000000&quot;, &quot;Avenida Paulista&quot;, 1023, &quot;Bela Vista&quot;,</span>
        &quot;Próximo ao Parque Trianon&quot;);

<span class="fc" id="L106">    Address work = new Address(</span>
<span class="fc" id="L107">        &quot;Campinas&quot;, &quot;São Paulo&quot;, &quot;02000022&quot;, &quot;Avenida Rosalita Fagundes&quot;, 152, &quot;Bosque&quot;,</span>
        &quot;Ao lado da padaria&quot;);

<span class="fc" id="L110">    Technician technician = new Technician(&quot;João Antônio Benevides Faria&quot;, &quot;77011114444&quot;,</span>
        &quot;joao@example.com&quot;);

<span class="fc" id="L113">    Plan plan = new Plan(&quot;Speed og Thunder&quot;, 300, 70.0);</span>

<span class="fc" id="L115">    Equipment router = new Equipment(EquipmentType.ROUTER, &quot;Asus RT-AC88U&quot;, &quot;SN035&quot;, &quot;Asus&quot;);</span>
<span class="fc" id="L116">    Equipment modem = new Equipment(EquipmentType.MODEM, &quot;Motorola MG7700&quot;, &quot;SN036&quot;, &quot;Motorola&quot;);</span>

<span class="fc" id="L118">    Equipment routerWork = new Equipment(EquipmentType.ROUTER, &quot;Asus RT-AC88U&quot;, &quot;SN099&quot;, &quot;Asus&quot;);</span>
<span class="fc" id="L119">    Equipment modemWork = new Equipment(EquipmentType.MODEM, &quot;Motorola MG7700&quot;, &quot;SN098&quot;,</span>
        &quot;Motorola&quot;);

<span class="fc" id="L122">    addressRepository.save(home);</span>
<span class="fc" id="L123">    addressRepository.save(work);</span>
<span class="fc" id="L124">    technicianRepository.save(technician);</span>
<span class="fc" id="L125">    planRepository.save(plan);</span>
<span class="fc" id="L126">    equipmentRepository.save(router);</span>
<span class="fc" id="L127">    equipmentRepository.save(modem);</span>
<span class="fc" id="L128">    equipmentRepository.save(routerWork);</span>
<span class="fc" id="L129">    equipmentRepository.save(modemWork);</span>

<span class="fc" id="L131">    List&lt;Equipment&gt; equipmentListHome = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L132">    equipmentListHome.add(router);</span>
<span class="fc" id="L133">    equipmentListHome.add(modem);</span>

<span class="fc" id="L135">    List&lt;Equipment&gt; equipmentListWork = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L136">    equipmentListWork.add(router);</span>
<span class="fc" id="L137">    equipmentListWork.add(modem);</span>

<span class="fc" id="L139">    Installation newInstallationHome = new Installation(home, plan, technician, equipmentListHome);</span>
<span class="fc" id="L140">    Installation newInstallationWork = new Installation(work, plan, technician, equipmentListWork);</span>

<span class="fc" id="L142">    installationRepository.save(newInstallationHome);</span>
<span class="fc" id="L143">    installationRepository.save(newInstallationWork);</span>

<span class="fc" id="L145">    String installationUrl = &quot;/installations&quot;;</span>

<span class="fc" id="L147">    mockMvc.perform(get(installationUrl)</span>
<span class="fc" id="L148">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L149">            .accept(MediaType.APPLICATION_JSON))</span>
<span class="fc" id="L150">        .andExpect(status().isOk())</span>
<span class="fc" id="L151">        .andExpect(jsonPath(&quot;$&quot;).isArray())</span>
<span class="fc" id="L152">        .andExpect(jsonPath(&quot;$.length()&quot;).value(2))</span>
<span class="fc" id="L153">        .andExpect(jsonPath(&quot;$[0].isActive&quot;).value(true))</span>
<span class="fc" id="L154">        .andExpect(jsonPath(&quot;$[0].id&quot;).value(newInstallationHome.getId()))</span>
<span class="fc" id="L155">        .andExpect(jsonPath(&quot;$[1].isActive&quot;).value(true))</span>
<span class="fc" id="L156">        .andExpect(jsonPath(&quot;$[1].id&quot;).value(newInstallationWork.getId()));</span>
<span class="fc" id="L157">  }</span>

  @Test
  @DisplayName(&quot;Retrieval installation by id&quot;)
  public void testInstallationRetrievalById() throws Exception {
<span class="fc" id="L162">    Address home = new Address(</span>
<span class="fc" id="L163">        &quot;São Paulo&quot;, &quot;São Paulo&quot;, &quot;01000000&quot;, &quot;Avenida Paulista&quot;, 1023, &quot;Bela Vista&quot;,</span>
        &quot;Próximo ao Parque Trianon&quot;);

<span class="fc" id="L166">    Technician technician = new Technician(&quot;João Antônio Benevides Faria&quot;, &quot;77011114444&quot;,</span>
        &quot;joao@example.com&quot;);

<span class="fc" id="L169">    Plan plan = new Plan(&quot;Speed og Thunder&quot;, 300, 70.0);</span>

<span class="fc" id="L171">    Equipment router = new Equipment(EquipmentType.ROUTER, &quot;Asus RT-AC88U&quot;, &quot;SN035&quot;, &quot;Asus&quot;);</span>
<span class="fc" id="L172">    Equipment modem = new Equipment(EquipmentType.MODEM, &quot;Motorola MG7700&quot;, &quot;SN036&quot;, &quot;Motorola&quot;);</span>

<span class="fc" id="L174">    addressRepository.save(home);</span>
<span class="fc" id="L175">    technicianRepository.save(technician);</span>
<span class="fc" id="L176">    planRepository.save(plan);</span>
<span class="fc" id="L177">    equipmentRepository.save(router);</span>
<span class="fc" id="L178">    equipmentRepository.save(modem);</span>

<span class="fc" id="L180">    List&lt;Equipment&gt; equipmentListHome = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L181">    equipmentListHome.add(router);</span>
<span class="fc" id="L182">    equipmentListHome.add(modem);</span>

<span class="fc" id="L184">    Installation newInstallationHome = new Installation(home, plan, technician, equipmentListHome);</span>

<span class="fc" id="L186">    installationRepository.save(newInstallationHome);</span>

<span class="fc" id="L188">    String installationUrl = &quot;/installations/%s&quot;.formatted(newInstallationHome.getId());</span>

<span class="fc" id="L190">    mockMvc.perform(get(installationUrl)</span>
<span class="fc" id="L191">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L192">            .accept(MediaType.APPLICATION_JSON))</span>
<span class="fc" id="L193">        .andExpect(status().isOk())</span>
<span class="fc" id="L194">        .andExpect(jsonPath(&quot;$.id&quot;).value(newInstallationHome.getId()))</span>
<span class="fc" id="L195">        .andExpect(jsonPath(&quot;$.isActive&quot;).value(true))</span>
<span class="fc" id="L196">        .andExpect(jsonPath(&quot;$.plan&quot;).exists())</span>
<span class="fc" id="L197">        .andExpect(jsonPath(&quot;$.technician&quot;).exists())</span>
<span class="fc" id="L198">        .andExpect(jsonPath(&quot;$.equipments&quot;).exists());</span>
<span class="fc" id="L199">  }</span>

  @Test
  @DisplayName(&quot;Update installation&quot;)
  public void testUpdateInstallation() throws Exception {

<span class="fc" id="L205">    Address home = new Address(</span>
<span class="fc" id="L206">        &quot;São Paulo&quot;, &quot;São Paulo&quot;, &quot;01000000&quot;, &quot;Avenida Paulista&quot;, 1023, &quot;Bela Vista&quot;,</span>
        &quot;Próximo ao Parque Trianon&quot;);

<span class="fc" id="L209">    Technician technician = new Technician(&quot;João Antônio Benevides Faria&quot;, &quot;77011114444&quot;,</span>
        &quot;joao@example.com&quot;);

<span class="fc" id="L212">    Plan plan = new Plan(&quot;Speed og Thunder&quot;, 300, 70.0);</span>

<span class="fc" id="L214">    Equipment router = new Equipment(EquipmentType.ROUTER, &quot;Asus RT-AC88U&quot;, &quot;SN035&quot;, &quot;Asus&quot;);</span>
<span class="fc" id="L215">    Equipment modem = new Equipment(EquipmentType.MODEM, &quot;Motorola MG7700&quot;, &quot;SN036&quot;, &quot;Motorola&quot;);</span>

<span class="fc" id="L217">    addressRepository.save(home);</span>
<span class="fc" id="L218">    technicianRepository.save(technician);</span>
<span class="fc" id="L219">    planRepository.save(plan);</span>
<span class="fc" id="L220">    equipmentRepository.save(router);</span>
<span class="fc" id="L221">    equipmentRepository.save(modem);</span>

<span class="fc" id="L223">    List&lt;Equipment&gt; equipmentListHome = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L224">    equipmentListHome.add(router);</span>
<span class="fc" id="L225">    equipmentListHome.add(modem);</span>

<span class="fc" id="L227">    List&lt;Long&gt; blankList = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L229">    Installation installationToUpdate = new Installation(home, plan, technician, equipmentListHome);</span>
<span class="fc" id="L230">    installationRepository.save(installationToUpdate);</span>

<span class="fc" id="L232">    InstallationCreationDto installationDto = new InstallationCreationDto(plan.getId(),</span>
<span class="fc" id="L233">        technician.getId(), blankList);</span>

<span class="fc" id="L235">    ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L236">    String updatedInstallationJson = objectMapper.writeValueAsString(installationDto);</span>

<span class="fc" id="L238">    String installationUrl = &quot;/installations/%s&quot;.formatted(installationToUpdate.getId());</span>

<span class="fc" id="L240">    mockMvc.perform(put(installationUrl)</span>
<span class="fc" id="L241">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L242">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L243">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L244">            .content(updatedInstallationJson))</span>
<span class="fc" id="L245">        .andExpect(status().isOk())</span>
<span class="fc" id="L246">        .andExpect(jsonPath(&quot;$.equipments&quot;).isEmpty());</span>
<span class="fc" id="L247">  }</span>

  @Test
  @DisplayName(&quot;Delete installation&quot;)
  public void testDeleteInstallation() throws Exception {

<span class="fc" id="L253">    Address home = new Address(</span>
<span class="fc" id="L254">        &quot;São Paulo&quot;, &quot;São Paulo&quot;, &quot;01000000&quot;, &quot;Avenida Paulista&quot;, 1023, &quot;Bela Vista&quot;,</span>
        &quot;Próximo ao Parque Trianon&quot;);

<span class="fc" id="L257">    Technician technician = new Technician(&quot;João Antônio Benevides Faria&quot;, &quot;77011114444&quot;,</span>
        &quot;joao@example.com&quot;);

<span class="fc" id="L260">    Plan plan = new Plan(&quot;Speed og Thunder&quot;, 300, 70.0);</span>

<span class="fc" id="L262">    Equipment router = new Equipment(EquipmentType.ROUTER, &quot;Asus RT-AC88U&quot;, &quot;SN035&quot;, &quot;Asus&quot;);</span>
<span class="fc" id="L263">    Equipment modem = new Equipment(EquipmentType.MODEM, &quot;Motorola MG7700&quot;, &quot;SN036&quot;, &quot;Motorola&quot;);</span>

<span class="fc" id="L265">    addressRepository.save(home);</span>
<span class="fc" id="L266">    technicianRepository.save(technician);</span>
<span class="fc" id="L267">    planRepository.save(plan);</span>
<span class="fc" id="L268">    equipmentRepository.save(router);</span>
<span class="fc" id="L269">    equipmentRepository.save(modem);</span>

<span class="fc" id="L271">    List&lt;Equipment&gt; equipmentListHome = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L272">    equipmentListHome.add(router);</span>
<span class="fc" id="L273">    equipmentListHome.add(modem);</span>

<span class="fc" id="L275">    Installation installationToDelete = new Installation(home, plan, technician, equipmentListHome);</span>
<span class="fc" id="L276">    installationRepository.save(installationToDelete);</span>

<span class="fc" id="L278">    String installationUrl = &quot;/installations/%s&quot;.formatted(installationToDelete.getId());</span>

<span class="fc" id="L280">    mockMvc.perform(delete(installationUrl)</span>
<span class="fc" id="L281">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L282">            .accept(MediaType.APPLICATION_JSON))</span>
<span class="fc" id="L283">        .andExpect(status().isOk())</span>
<span class="fc" id="L284">        .andExpect(jsonPath(&quot;$.id&quot;).value(installationToDelete.getId()))</span>
<span class="fc" id="L285">        .andExpect(jsonPath(&quot;$.plan&quot;).exists())</span>
<span class="fc" id="L286">        .andExpect(jsonPath(&quot;$.technician&quot;).exists())</span>
<span class="fc" id="L287">        .andExpect(jsonPath(&quot;$.equipments&quot;).exists());</span>
    ;
<span class="fc" id="L289">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CustomerIntegrationTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in w-net-internet Coverage Results</a> &gt; <a href="index.source.html" class="el_package">com.maires.wnet.integration</a> &gt; <span class="el_source">CustomerIntegrationTest.java</span></div><h1>CustomerIntegrationTest.java</h1><pre class="source lang-java linenums">package com.maires.wnet.integration;

import static org.hamcrest.Matchers.nullValue;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.put;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

import com.maires.wnet.entity.Address;
import com.maires.wnet.entity.Customer;
import com.maires.wnet.entity.User;
import com.maires.wnet.repository.AddressRepository;
import com.maires.wnet.repository.CustomerRepository;
import com.maires.wnet.repository.EquipmentRepository;
import com.maires.wnet.repository.InstallationRepository;
import com.maires.wnet.repository.PlanRepository;
import com.maires.wnet.repository.TechnicianRepository;
import com.maires.wnet.repository.UserRepository;
import com.maires.wnet.security.Role;
import com.maires.wnet.service.TokenService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.test.context.DynamicPropertyRegistry;
import org.springframework.test.context.DynamicPropertySource;
import org.springframework.test.web.servlet.MockMvc;
import org.testcontainers.containers.KafkaContainer;
import org.testcontainers.containers.PostgreSQLContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;
import org.testcontainers.shaded.com.fasterxml.jackson.databind.ObjectMapper;

@SpringBootTest
@AutoConfigureMockMvc
@Testcontainers
@DisplayName(&quot;Customer integration tests&quot;)
<span class="fc" id="L44">public class CustomerIntegrationTest {</span>

  @Container
<span class="fc" id="L47">  public static PostgreSQLContainer POSTGRES_CONTAINER = new PostgreSQLContainer(&quot;postgres&quot;)</span>
<span class="fc" id="L48">      .withDatabaseName(&quot;wnetdb&quot;);</span>
  @Container
<span class="fc" id="L50">  public static KafkaContainer KAFKA_CONTAINER = new KafkaContainer();</span>
  @Autowired
  CustomerRepository customerRepository;
  @Autowired
  AddressRepository addressRepository;
  @Autowired
  UserRepository userRepository;
  @Autowired
  TechnicianRepository technicianRepository;
  @Autowired
  EquipmentRepository equipmentRepository;
  @Autowired
  PlanRepository planRepository;
  @Autowired
  InstallationRepository installationRepository;
  @Autowired
  MockMvc mockMvc;
  @Autowired
  private TokenService tokenService;
  private String tokenAdmin;

  @DynamicPropertySource
  public static void overrideProperties(DynamicPropertyRegistry registry) {
<span class="fc" id="L73">    registry.add(&quot;spring.datasource.url&quot;, POSTGRES_CONTAINER::getJdbcUrl);</span>
<span class="fc" id="L74">    registry.add(&quot;spring.datasource.username&quot;, POSTGRES_CONTAINER::getUsername);</span>
<span class="fc" id="L75">    registry.add(&quot;spring.datasource.password&quot;, POSTGRES_CONTAINER::getPassword);</span>
<span class="fc" id="L76">    registry.add(&quot;spring.kafka.bootstrap-servers&quot;, KAFKA_CONTAINER::getBootstrapServers);</span>
<span class="fc" id="L77">  }</span>

  @BeforeEach
  public void cleanUp() {
<span class="fc" id="L81">    userRepository.deleteAll();</span>
<span class="fc" id="L82">    customerRepository.deleteAll();</span>
<span class="fc" id="L83">    User admin = new User(null, &quot;System Manager Administrator&quot;, &quot;admin@mail.com&quot;, &quot;admin&quot;,</span>
        &quot;segredo123&quot;,
        Role.ADMIN);
<span class="fc" id="L86">    User userAdmin = userRepository.save(admin);</span>
<span class="fc" id="L87">    tokenAdmin = tokenService.generateToken(userAdmin.getUsername());</span>
<span class="fc" id="L88">  }</span>

  @Test
  @DisplayName(&quot;Retrieval all Customers&quot;)
  public void testCustomerRetrievalAll() throws Exception {
<span class="fc" id="L93">    Customer everaldo = new Customer(&quot;Everaldo Soares Cordeiro&quot;, &quot;00011122233&quot;, &quot;77000001111&quot;,</span>
        &quot;everaldo@mail.com&quot;);
<span class="fc" id="L95">    Customer machado = new Customer(&quot;Joaquim Maria Machado de Assis&quot;, &quot;93684193020&quot;,</span>
        &quot;77009901111&quot;,
        &quot;machado@mail.com&quot;);

<span class="fc" id="L99">    customerRepository.save(everaldo);</span>
<span class="fc" id="L100">    customerRepository.save(machado);</span>
<span class="fc" id="L101">    String customerUrl = &quot;/customers&quot;;</span>

<span class="fc" id="L103">    mockMvc.perform(get(customerUrl)</span>
<span class="fc" id="L104">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L105">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin))</span>
<span class="fc" id="L106">        .andExpect(status().isOk())</span>
<span class="fc" id="L107">        .andExpect(jsonPath(&quot;$&quot;).isArray())</span>
<span class="fc" id="L108">        .andExpect(jsonPath(&quot;$.length()&quot;).value(2))</span>
<span class="fc" id="L109">        .andExpect(jsonPath(&quot;$[0].id&quot;).exists())</span>
<span class="fc" id="L110">        .andExpect(jsonPath(&quot;$[0].fullName&quot;).value(&quot;Everaldo Soares Cordeiro&quot;))</span>
<span class="fc" id="L111">        .andExpect(jsonPath(&quot;$[1].id&quot;).exists())</span>
<span class="fc" id="L112">        .andExpect(jsonPath(&quot;$[1].fullName&quot;).value(&quot;Joaquim Maria Machado de Assis&quot;));</span>
<span class="fc" id="L113">  }</span>

  @Test
  @DisplayName(&quot;Retrieval customer by id&quot;)
  public void testCustomerRetrievalById() throws Exception {
<span class="fc" id="L118">    Customer machado = new Customer(&quot;Joaquim Maria Machado de Assis&quot;, &quot;93684193020&quot;,</span>
        &quot;77009901111&quot;,
        &quot;machado@mail.com&quot;);

<span class="fc" id="L122">    customerRepository.save(machado);</span>
<span class="fc" id="L123">    String customerUrl = &quot;/customers/%s&quot;.formatted(machado.getId());</span>

<span class="fc" id="L125">    mockMvc.perform(get(customerUrl)</span>
<span class="fc" id="L126">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L127">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin))</span>
<span class="fc" id="L128">        .andExpect(status().isOk())</span>
<span class="fc" id="L129">        .andExpect(jsonPath(&quot;$.id&quot;).exists())</span>
<span class="fc" id="L130">        .andExpect(jsonPath(&quot;$.fullName&quot;).value(&quot;Joaquim Maria Machado de Assis&quot;))</span>
<span class="fc" id="L131">        .andExpect(jsonPath(&quot;$.cpf&quot;).value(&quot;93684193020&quot;))</span>
<span class="fc" id="L132">        .andExpect(jsonPath(&quot;$.phone&quot;).value(&quot;77009901111&quot;))</span>
<span class="fc" id="L133">        .andExpect(jsonPath(&quot;$.email&quot;).value(&quot;machado@mail.com&quot;));</span>
<span class="fc" id="L134">  }</span>

  @Test
  @DisplayName(&quot;Throw customerNotFoundException by id&quot;)
  public void testCustomerNotFoundExceptionById() throws Exception {

<span class="fc" id="L140">    String customerUrl = &quot;/customers/666&quot;;</span>

<span class="fc" id="L142">    mockMvc.perform(get(customerUrl)</span>
<span class="fc" id="L143">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L144">            .accept(MediaType.APPLICATION_JSON))</span>
<span class="fc" id="L145">        .andExpect(status().isNotFound())</span>
<span class="fc" id="L146">        .andExpect(jsonPath(&quot;$.message&quot;).value(&quot;Customer not found with identifier 666!&quot;));</span>
<span class="fc" id="L147">  }</span>

  @Test
  @DisplayName(&quot;Retrieval all addresses by customer&quot;)
  public void testAddressesRetrievalByCustomer() throws Exception {
<span class="fc" id="L152">    Customer machado = new Customer(&quot;Joaquim Maria Machado de Assis&quot;, &quot;93684193020&quot;,</span>
        &quot;77009901111&quot;,
        &quot;machado@mail.com&quot;);

<span class="fc" id="L156">    customerRepository.save(machado);</span>

<span class="fc" id="L158">    Address home = new Address(</span>
        &quot;São Paulo&quot;,
        &quot;São Paulo&quot;,
        &quot;01000000&quot;,
        &quot;Avenida Paulista&quot;,
<span class="fc" id="L163">        1023,</span>
        &quot;Próximo ao Parque Trianon&quot;,
        &quot;Bela Vista&quot;
    );
<span class="fc" id="L167">    Address work = new Address(</span>
        &quot;São Paulo&quot;,
        &quot;São Paulo&quot;,
        &quot;13000000&quot;,
        &quot;Fazenda Santo Antônio&quot;,
        null,
        &quot;Próximo ao Lago Azul&quot;,
        &quot;Zona Rural&quot;
    );

<span class="fc" id="L177">    home.setCustomer(machado);</span>
<span class="fc" id="L178">    work.setCustomer(machado);</span>
<span class="fc" id="L179">    addressRepository.save(home);</span>
<span class="fc" id="L180">    addressRepository.save(work);</span>

<span class="fc" id="L182">    String customerUrl = &quot;/customers/%s/addresses&quot;.formatted(machado.getId());</span>

<span class="fc" id="L184">    mockMvc.perform(get(customerUrl)</span>
<span class="fc" id="L185">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L186">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin))</span>
<span class="fc" id="L187">        .andExpect(status().isOk())</span>
<span class="fc" id="L188">        .andExpect(jsonPath(&quot;$&quot;).isArray())</span>
<span class="fc" id="L189">        .andExpect(jsonPath(&quot;$.length()&quot;).value(2))</span>
<span class="fc" id="L190">        .andExpect(jsonPath(&quot;$[0].street&quot;).value(&quot;Avenida Paulista&quot;))</span>
<span class="fc" id="L191">        .andExpect(jsonPath(&quot;$[0].streetNumber&quot;).value(1023))</span>
<span class="fc" id="L192">        .andExpect(jsonPath(&quot;$[1].street&quot;).value(&quot;Fazenda Santo Antônio&quot;))</span>
<span class="fc" id="L193">        .andExpect(jsonPath(&quot;$[1].streetNumber&quot;).value(nullValue()));</span>
<span class="fc" id="L194">  }</span>

  @Test
  @DisplayName(&quot;Throw customerNotFoundException by address&quot;)
  public void testCustomerNotFoundExceptionByAddress() throws Exception {

<span class="fc" id="L200">    String customerUrl = &quot;/customers/666/addresses&quot;;</span>

<span class="fc" id="L202">    mockMvc.perform(get(customerUrl)</span>
<span class="fc" id="L203">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L204">            .accept(MediaType.APPLICATION_JSON))</span>
<span class="fc" id="L205">        .andExpect(status().isNotFound())</span>
<span class="fc" id="L206">        .andExpect(jsonPath(&quot;$.message&quot;).value(&quot;Customer not found with identifier 666!&quot;));</span>
<span class="fc" id="L207">  }</span>

  @Test
  @DisplayName(&quot;Create customer&quot;)
  public void testCreateCustomer() throws Exception {

<span class="fc" id="L213">    Customer newCustomer = new Customer(&quot;Joaquim Maria Machado de Assis&quot;, &quot;93684193020&quot;,</span>
        &quot;77009901111&quot;,
        &quot;machado@mail.com&quot;);

<span class="fc" id="L217">    ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L218">    String newCustomerJson = objectMapper.writeValueAsString(newCustomer);</span>
<span class="fc" id="L219">    String customerUrl = &quot;/customers&quot;;</span>

<span class="fc" id="L221">    mockMvc.perform(post(customerUrl)</span>
<span class="fc" id="L222">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L223">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L224">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L225">            .content(newCustomerJson))</span>
<span class="fc" id="L226">        .andExpect(status().isCreated())</span>
<span class="fc" id="L227">        .andExpect(jsonPath(&quot;$.id&quot;).exists())</span>
<span class="fc" id="L228">        .andExpect(jsonPath(&quot;$.fullName&quot;).value(&quot;Joaquim Maria Machado de Assis&quot;))</span>
<span class="fc" id="L229">        .andExpect(jsonPath(&quot;$.cpf&quot;).value(&quot;93684193020&quot;))</span>
<span class="fc" id="L230">        .andExpect(jsonPath(&quot;$.phone&quot;).value(&quot;77009901111&quot;))</span>
<span class="fc" id="L231">        .andExpect(jsonPath(&quot;$.email&quot;).value(&quot;machado@mail.com&quot;));</span>
<span class="fc" id="L232">  }</span>

  @Test
  @DisplayName(&quot;Update customer&quot;)
  public void testUpdateCustomer() throws Exception {

<span class="fc" id="L238">    Customer customerToUpdate = new Customer(&quot;Joaquim Maria Machado de Assis&quot;, &quot;93684193020&quot;,</span>
        &quot;77009901111&quot;,
        &quot;machadodexango@mail.com&quot;);

<span class="fc" id="L242">    customerRepository.save(customerToUpdate);</span>

<span class="fc" id="L244">    customerToUpdate.setFullName(&quot;Joaquim Maria Machado de Assis de Xangô&quot;);</span>
<span class="fc" id="L245">    customerToUpdate.setEmail(&quot;machadodexango@mail.com&quot;);</span>

<span class="fc" id="L247">    ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L248">    String updatedCustomerJson = objectMapper.writeValueAsString(customerToUpdate);</span>
<span class="fc" id="L249">    String customerUrl = &quot;/customers/%s&quot;.formatted(customerToUpdate.getId());</span>

<span class="fc" id="L251">    mockMvc.perform(put(customerUrl)</span>
<span class="fc" id="L252">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L253">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L254">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L255">            .content(updatedCustomerJson))</span>
<span class="fc" id="L256">        .andExpect(status().isOk())</span>
<span class="fc" id="L257">        .andExpect(jsonPath(&quot;$.id&quot;).exists())</span>
<span class="fc" id="L258">        .andExpect(jsonPath(&quot;$.fullName&quot;).value(&quot;Joaquim Maria Machado de Assis de Xangô&quot;))</span>
<span class="fc" id="L259">        .andExpect(jsonPath(&quot;$.cpf&quot;).value(&quot;93684193020&quot;))</span>
<span class="fc" id="L260">        .andExpect(jsonPath(&quot;$.phone&quot;).value(&quot;77009901111&quot;))</span>
<span class="fc" id="L261">        .andExpect(jsonPath(&quot;$.email&quot;).value(&quot;machadodexango@mail.com&quot;));</span>
<span class="fc" id="L262">  }</span>

  @Test
  @DisplayName(&quot;Create customer address&quot;)
  public void testCreateCustomerAddress() throws Exception {

<span class="fc" id="L268">    Customer customer = new Customer(&quot;Joaquim Maria Machado de Assis&quot;, &quot;93684193020&quot;,</span>
        &quot;77009901111&quot;,
        &quot;machado@mail.com&quot;);

<span class="fc" id="L272">    customerRepository.save(customer);</span>

<span class="fc" id="L274">    Address newAddress = new Address(</span>
        &quot;São Paulo&quot;,
        &quot;São Paulo&quot;,
        &quot;01000000&quot;,
        &quot;Avenida Paulista&quot;,
<span class="fc" id="L279">        1023,</span>
        &quot;Bela Vista&quot;,
        &quot;Próximo ao Parque Trianon&quot;

    );

<span class="fc" id="L285">    ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L286">    String newAddressJson = objectMapper.writeValueAsString(newAddress);</span>
<span class="fc" id="L287">    String customerUrl = &quot;/customers/%s/addresses&quot;.formatted(customer.getId());</span>

<span class="fc" id="L289">    mockMvc.perform(post(customerUrl)</span>
<span class="fc" id="L290">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L291">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L292">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L293">            .content(newAddressJson))</span>
<span class="fc" id="L294">        .andExpect(status().isCreated())</span>
<span class="fc" id="L295">        .andExpect(jsonPath(&quot;$.city&quot;).value(&quot;São Paulo&quot;))</span>
<span class="fc" id="L296">        .andExpect(jsonPath(&quot;$.state&quot;).value(&quot;São Paulo&quot;))</span>
<span class="fc" id="L297">        .andExpect(jsonPath(&quot;$.zipCode&quot;).value(&quot;01000000&quot;))</span>
<span class="fc" id="L298">        .andExpect(jsonPath(&quot;$.street&quot;).value(&quot;Avenida Paulista&quot;))</span>
<span class="fc" id="L299">        .andExpect(jsonPath(&quot;$.streetNumber&quot;).value(1023))</span>
<span class="fc" id="L300">        .andExpect(jsonPath(&quot;$.neighborhood&quot;).value(&quot;Bela Vista&quot;))</span>
<span class="fc" id="L301">        .andExpect(jsonPath(&quot;$.complement&quot;).value(&quot;Próximo ao Parque Trianon&quot;));</span>
<span class="fc" id="L302">  }</span>

  @Test
  @DisplayName(&quot;Throw customerNotFoundException by creating address&quot;)
  public void testCustomerNotFoundExceptionByCreateAddress() throws Exception {

<span class="fc" id="L308">    Address newAddress = new Address(</span>
        &quot;São Paulo&quot;,
        &quot;São Paulo&quot;,
        &quot;01000000&quot;,
        &quot;Avenida Paulista&quot;,
<span class="fc" id="L313">        1023,</span>
        &quot;Bela Vista&quot;,
        &quot;Próximo ao Parque Trianon&quot;

    );

<span class="fc" id="L319">    ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L320">    String newAddressJson = objectMapper.writeValueAsString(newAddress);</span>
<span class="fc" id="L321">    String customerUrl = &quot;/customers/666/addresses&quot;;</span>

<span class="fc" id="L323">    mockMvc.perform(post(customerUrl)</span>
<span class="fc" id="L324">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L325">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L326">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L327">            .content(newAddressJson))</span>
<span class="fc" id="L328">        .andExpect(status().isNotFound())</span>
<span class="fc" id="L329">        .andExpect(jsonPath(&quot;$.message&quot;).value(&quot;Customer not found with identifier 666!&quot;));</span>
<span class="fc" id="L330">  }</span>

  @Test
  @DisplayName(&quot;Delete Customer&quot;)
  public void testDeleteCustomer() throws Exception {

<span class="fc" id="L336">    Customer customerToDelete = new Customer(&quot;Gilvan Carlos Ferreira&quot;, &quot;93684193020&quot;,</span>
        &quot;77009901111&quot;,
        &quot;ferreira@mail.com&quot;);
<span class="fc" id="L339">    customerRepository.save(customerToDelete);</span>

<span class="fc" id="L341">    String customerUrl = &quot;/customers/%s&quot;.formatted(customerToDelete.getId());</span>

<span class="fc" id="L343">    mockMvc.perform(delete(customerUrl)</span>
<span class="fc" id="L344">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L345">            .accept(MediaType.APPLICATION_JSON))</span>
<span class="fc" id="L346">        .andExpect(status().isOk())</span>
<span class="fc" id="L347">        .andExpect(jsonPath(&quot;$.id&quot;).exists())</span>
<span class="fc" id="L348">        .andExpect(jsonPath(&quot;$.fullName&quot;).value(&quot;Gilvan Carlos Ferreira&quot;))</span>
<span class="fc" id="L349">        .andExpect(jsonPath(&quot;$.cpf&quot;).value(&quot;93684193020&quot;))</span>
<span class="fc" id="L350">        .andExpect(jsonPath(&quot;$.phone&quot;).value(&quot;77009901111&quot;))</span>
<span class="fc" id="L351">        .andExpect(jsonPath(&quot;$.email&quot;).value(&quot;ferreira@mail.com&quot;));</span>
<span class="fc" id="L352">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>
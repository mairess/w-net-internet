<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TechnicianIntegrationTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in w-net-internet Coverage Results</a> &gt; <a href="index.source.html" class="el_package">com.maires.wnet.integration</a> &gt; <span class="el_source">TechnicianIntegrationTest.java</span></div><h1>TechnicianIntegrationTest.java</h1><pre class="source lang-java linenums">package com.maires.wnet.integration;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.put;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

import com.maires.wnet.entity.Address;
import com.maires.wnet.entity.Customer;
import com.maires.wnet.entity.Equipment;
import com.maires.wnet.entity.EquipmentType;
import com.maires.wnet.entity.Installation;
import com.maires.wnet.entity.Plan;
import com.maires.wnet.entity.Technician;
import com.maires.wnet.entity.User;
import com.maires.wnet.repository.AddressRepository;
import com.maires.wnet.repository.CustomerRepository;
import com.maires.wnet.repository.EquipmentRepository;
import com.maires.wnet.repository.InstallationRepository;
import com.maires.wnet.repository.PlanRepository;
import com.maires.wnet.repository.TechnicianRepository;
import com.maires.wnet.repository.UserRepository;
import com.maires.wnet.security.Role;
import com.maires.wnet.service.TokenService;
import java.util.ArrayList;
import java.util.List;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.test.context.DynamicPropertyRegistry;
import org.springframework.test.context.DynamicPropertySource;
import org.springframework.test.web.servlet.MockMvc;
import org.testcontainers.containers.KafkaContainer;
import org.testcontainers.containers.PostgreSQLContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;
import org.testcontainers.shaded.com.fasterxml.jackson.databind.ObjectMapper;

@SpringBootTest
@AutoConfigureMockMvc
@Testcontainers
@DisplayName(&quot;Technician integration tests&quot;)
<span class="fc" id="L50">public class TechnicianIntegrationTest {</span>

  @Container
<span class="fc" id="L53">  public static PostgreSQLContainer POSTGRES_CONTAINER = new PostgreSQLContainer(&quot;postgres&quot;)</span>
<span class="fc" id="L54">      .withDatabaseName(&quot;wnetdb&quot;);</span>
  @Container
<span class="fc" id="L56">  public static KafkaContainer KAFKA_CONTAINER = new KafkaContainer();</span>
  @Autowired
  TechnicianRepository technicianRepository;
  @Autowired
  UserRepository userRepository;
  @Autowired
  AddressRepository addressRepository;
  @Autowired
  EquipmentRepository equipmentRepository;
  @Autowired
  CustomerRepository customerRepository;
  @Autowired
  InstallationRepository installationRepository;
  @Autowired
  PlanRepository planRepository;
  @Autowired
  MockMvc mockMvc;
  @Autowired
  private TokenService tokenService;
  private String tokenAdmin;


  @DynamicPropertySource
  public static void overrideProperties(DynamicPropertyRegistry registry) {
<span class="fc" id="L80">    registry.add(&quot;spring.datasource.url&quot;, POSTGRES_CONTAINER::getJdbcUrl);</span>
<span class="fc" id="L81">    registry.add(&quot;spring.datasource.username&quot;, POSTGRES_CONTAINER::getUsername);</span>
<span class="fc" id="L82">    registry.add(&quot;spring.datasource.password&quot;, POSTGRES_CONTAINER::getPassword);</span>
<span class="fc" id="L83">    registry.add(&quot;spring.kafka.bootstrap-servers&quot;, KAFKA_CONTAINER::getBootstrapServers);</span>
<span class="fc" id="L84">  }</span>

  @BeforeEach
  public void cleanUp() {
<span class="fc" id="L88">    userRepository.deleteAll();</span>
<span class="fc" id="L89">    installationRepository.deleteAll();</span>
<span class="fc" id="L90">    technicianRepository.deleteAll();</span>
<span class="fc" id="L91">    User admin = new User(null, &quot;System Manager Administrator&quot;, &quot;admin@mail.com&quot;, &quot;admin&quot;,</span>
        &quot;segredo123&quot;,
        Role.ADMIN);
<span class="fc" id="L94">    User userAdmin = userRepository.save(admin);</span>
<span class="fc" id="L95">    tokenAdmin = tokenService.generateToken(userAdmin.getUsername());</span>
<span class="fc" id="L96">  }</span>

  @Test
  @DisplayName(&quot;Retrieval all technicians&quot;)
  public void testTechnicianRetrievalAll() throws Exception {
<span class="fc" id="L101">    Technician Alberto = new Technician(&quot;Alberto Benevides de Castro&quot;, &quot;7799000000000&quot;,</span>
        &quot;alberto@mail.com&quot;);
<span class="fc" id="L103">    Technician Amarildo = new Technician(&quot;Amarildo Xavier da Costa&quot;, &quot;7799111111111&quot;,</span>
        &quot;amarildo@mail.com&quot;);

<span class="fc" id="L106">    technicianRepository.save(Alberto);</span>
<span class="fc" id="L107">    technicianRepository.save(Amarildo);</span>
<span class="fc" id="L108">    String technicianUrl = &quot;/technicians&quot;;</span>

<span class="fc" id="L110">    mockMvc.perform(get(technicianUrl)</span>
<span class="fc" id="L111">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L112">            .accept(MediaType.APPLICATION_JSON))</span>
<span class="fc" id="L113">        .andExpect(status().isOk())</span>
<span class="fc" id="L114">        .andExpect(jsonPath(&quot;$&quot;).isArray())</span>
<span class="fc" id="L115">        .andExpect(jsonPath(&quot;$.length()&quot;).value(2))</span>
<span class="fc" id="L116">        .andExpect(jsonPath(&quot;$[0].id&quot;).exists())</span>
<span class="fc" id="L117">        .andExpect(jsonPath(&quot;$[0].fullName&quot;).value(&quot;Alberto Benevides de Castro&quot;))</span>
<span class="fc" id="L118">        .andExpect(jsonPath(&quot;$[1].id&quot;).exists())</span>
<span class="fc" id="L119">        .andExpect(jsonPath(&quot;$[1].fullName&quot;).value(&quot;Amarildo Xavier da Costa&quot;));</span>
<span class="fc" id="L120">  }</span>

  @Test
  @DisplayName(&quot;Retrieval technician by id&quot;)
  public void testTechnicianRetrievalById() throws Exception {
<span class="fc" id="L125">    Technician Amarildo = new Technician(&quot;Amarildo Xavier da Costa&quot;, &quot;7799111111111&quot;,</span>
        &quot;amarildo@mail.com&quot;);
<span class="fc" id="L127">    technicianRepository.save(Amarildo);</span>

<span class="fc" id="L129">    String technicianUrl = &quot;/technicians/%s&quot;.formatted(Amarildo.getId());</span>

<span class="fc" id="L131">    mockMvc.perform(get(technicianUrl)</span>
<span class="fc" id="L132">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L133">            .accept(MediaType.APPLICATION_JSON))</span>
<span class="fc" id="L134">        .andExpect(status().isOk())</span>
<span class="fc" id="L135">        .andExpect(jsonPath(&quot;$.id&quot;).exists())</span>
<span class="fc" id="L136">        .andExpect(jsonPath(&quot;$.fullName&quot;).value(&quot;Amarildo Xavier da Costa&quot;))</span>
<span class="fc" id="L137">        .andExpect(jsonPath(&quot;$.phone&quot;).value(&quot;7799111111111&quot;))</span>
<span class="fc" id="L138">        .andExpect(jsonPath(&quot;$.email&quot;).value(&quot;amarildo@mail.com&quot;));</span>
<span class="fc" id="L139">  }</span>

  @Test
  @DisplayName(&quot;Throw technicianNotFoundException&quot;)
  public void testTechnicianNotFoundExceptionById() throws Exception {

<span class="fc" id="L145">    String technicianUrl = &quot;/technicians/666&quot;;</span>

<span class="fc" id="L147">    mockMvc.perform(get(technicianUrl)</span>
<span class="fc" id="L148">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L149">            .accept(MediaType.APPLICATION_JSON))</span>
<span class="fc" id="L150">        .andExpect(status().isNotFound())</span>
<span class="fc" id="L151">        .andExpect(jsonPath(&quot;$.message&quot;).value(&quot;Technician not found with identifier 666!&quot;));</span>
<span class="fc" id="L152">  }</span>

  @Test
  @DisplayName(&quot;Create technician&quot;)
  public void testCreateTechnician() throws Exception {

<span class="fc" id="L158">    Technician Amarildo = new Technician(&quot;Amarildo Xavier da Costa&quot;, &quot;7799111111111&quot;,</span>
        &quot;amarildo@mail.com&quot;);

<span class="fc" id="L161">    ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L162">    String newTechnicianJson = objectMapper.writeValueAsString(Amarildo);</span>
<span class="fc" id="L163">    String technicianUrl = &quot;/technicians&quot;;</span>

<span class="fc" id="L165">    mockMvc.perform(post(technicianUrl)</span>
<span class="fc" id="L166">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L167">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L168">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L169">            .content(newTechnicianJson))</span>
<span class="fc" id="L170">        .andExpect(status().isCreated())</span>
<span class="fc" id="L171">        .andExpect(jsonPath(&quot;$.id&quot;).exists())</span>
<span class="fc" id="L172">        .andExpect(jsonPath(&quot;$.fullName&quot;).value(&quot;Amarildo Xavier da Costa&quot;))</span>
<span class="fc" id="L173">        .andExpect(jsonPath(&quot;$.phone&quot;).value(&quot;7799111111111&quot;))</span>
<span class="fc" id="L174">        .andExpect(jsonPath(&quot;$.email&quot;).value(&quot;amarildo@mail.com&quot;));</span>
<span class="fc" id="L175">  }</span>

  @Test
  @DisplayName(&quot;Update technician&quot;)
  public void testUpdateTechnician() throws Exception {

<span class="fc" id="L181">    Technician technicianToUpdate = new Technician(&quot;Amarildo Xavier da Costa&quot;, &quot;7799111111111&quot;,</span>
        &quot;amarildo@mail.com&quot;);
<span class="fc" id="L183">    technicianRepository.save(technicianToUpdate);</span>

<span class="fc" id="L185">    technicianToUpdate.setFullName(&quot;Amarildo Candido Xavier&quot;);</span>
<span class="fc" id="L186">    technicianToUpdate.setPhone(&quot;7799222222222&quot;);</span>

<span class="fc" id="L188">    ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L189">    String updatedTechnicianJson = objectMapper.writeValueAsString(technicianToUpdate);</span>
<span class="fc" id="L190">    String technicianUrl = &quot;/technicians/%s&quot;.formatted(technicianToUpdate.getId());</span>

<span class="fc" id="L192">    mockMvc.perform(put(technicianUrl)</span>
<span class="fc" id="L193">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L194">            .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L195">            .accept(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L196">            .content(updatedTechnicianJson))</span>
<span class="fc" id="L197">        .andExpect(status().isOk())</span>
<span class="fc" id="L198">        .andExpect(jsonPath(&quot;$.id&quot;).exists())</span>
<span class="fc" id="L199">        .andExpect(jsonPath(&quot;$.fullName&quot;).value(&quot;Amarildo Candido Xavier&quot;))</span>
<span class="fc" id="L200">        .andExpect(jsonPath(&quot;$.phone&quot;).value(&quot;7799222222222&quot;))</span>
<span class="fc" id="L201">        .andExpect(jsonPath(&quot;$.email&quot;).value(&quot;amarildo@mail.com&quot;));</span>
<span class="fc" id="L202">  }</span>

  @Test
  @DisplayName(&quot;Delete technician&quot;)
  public void testDeleteTechnician() throws Exception {

<span class="fc" id="L208">    Technician technicianToDelete = new Technician(&quot;Amarildo Xavier da Costa&quot;, &quot;7799111111111&quot;,</span>
        &quot;amarildo@mail.com&quot;);

<span class="fc" id="L211">    technicianRepository.save(technicianToDelete);</span>
<span class="fc" id="L212">    String technicianUrl = &quot;/technicians/%s&quot;.formatted(technicianToDelete.getId());</span>

<span class="fc" id="L214">    mockMvc.perform(delete(technicianUrl)</span>
<span class="fc" id="L215">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L216">            .accept(MediaType.APPLICATION_JSON))</span>
<span class="fc" id="L217">        .andExpect(status().isOk())</span>
<span class="fc" id="L218">        .andExpect(jsonPath(&quot;$.id&quot;).exists())</span>
<span class="fc" id="L219">        .andExpect(jsonPath(&quot;$.fullName&quot;).value(&quot;Amarildo Xavier da Costa&quot;))</span>
<span class="fc" id="L220">        .andExpect(jsonPath(&quot;$.phone&quot;).value(&quot;7799111111111&quot;))</span>
<span class="fc" id="L221">        .andExpect(jsonPath(&quot;$.email&quot;).value(&quot;amarildo@mail.com&quot;));</span>
<span class="fc" id="L222">  }</span>

  @Test
  @DisplayName(&quot;Throw technicianCannotBeExcludedException&quot;)
  public void testTechnicianCannotBeExcludedException() throws Exception {

<span class="fc" id="L228">    Customer customer = new Customer(</span>
        &quot;Graciliano Ramos de Oliveira&quot;,
        &quot;00011122233&quot;,
        &quot;77011223344&quot;,
        &quot;gracit@example.com&quot;
    );

<span class="fc" id="L235">    Address home = new Address(</span>
<span class="fc" id="L236">        &quot;São Paulo&quot;, &quot;São Paulo&quot;, &quot;01000000&quot;, &quot;Avenida Paulista&quot;, 1023, &quot;Bela Vista&quot;,</span>
        &quot;Próximo ao Parque Trianon&quot;);

<span class="fc" id="L239">    Technician technician = new Technician(&quot;João Antônio Benevides Faria&quot;, &quot;77011114444&quot;,</span>
        &quot;joao@example.com&quot;);

<span class="fc" id="L242">    Plan plan = new Plan(&quot;Speed og Thunder&quot;, 300, 70.0);</span>

<span class="fc" id="L244">    Equipment router = new Equipment(EquipmentType.ROUTER, &quot;Asus RT-AC88U&quot;, &quot;SN035&quot;, &quot;Asus&quot;);</span>
<span class="fc" id="L245">    Equipment modem = new Equipment(EquipmentType.MODEM, &quot;Motorola MG7700&quot;, &quot;SN036&quot;, &quot;Motorola&quot;);</span>

<span class="fc" id="L247">    home.setCustomer(customer);</span>
<span class="fc" id="L248">    customerRepository.save(customer);</span>
<span class="fc" id="L249">    addressRepository.save(home);</span>
<span class="fc" id="L250">    technicianRepository.save(technician);</span>
<span class="fc" id="L251">    planRepository.save(plan);</span>
<span class="fc" id="L252">    equipmentRepository.save(router);</span>
<span class="fc" id="L253">    equipmentRepository.save(modem);</span>

<span class="fc" id="L255">    List&lt;Equipment&gt; equipmentList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L256">    equipmentList.add(router);</span>
<span class="fc" id="L257">    equipmentList.add(modem);</span>

<span class="fc" id="L259">    Installation installation = new Installation(home, plan, technician, equipmentList);</span>

<span class="fc" id="L261">    installationRepository.save(installation);</span>

<span class="fc" id="L263">    String technicianUrl = &quot;/technicians/%s&quot;.formatted(technician.getId());</span>

<span class="fc" id="L265">    mockMvc.perform(delete(technicianUrl)</span>
<span class="fc" id="L266">            .header(HttpHeaders.AUTHORIZATION, &quot;Bearer &quot; + tokenAdmin)</span>
<span class="fc" id="L267">            .accept(MediaType.APPLICATION_JSON))</span>
<span class="fc" id="L268">        .andExpect(status().isConflict())</span>
<span class="fc" id="L269">        .andExpect(jsonPath(&quot;$.message&quot;).value(</span>
            &quot;This Technician cannot be excluded because he has an association!&quot;));
<span class="fc" id="L271">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>